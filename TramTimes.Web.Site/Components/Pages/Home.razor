@inject HttpClient HttpService
@inject NavigationManager NavigationService
@inject IHttpContextAccessor AccessorService
@inject IJSRuntime JavascriptService
@inject ILocalStorageService StorageService
@inject ILogger<Home> LoggerService
@inject IMapper MapperService

@implements IAsyncDisposable

@page "/"
@page "/{Longitude:double}/{Latitude:double}"
@page "/{Longitude:double}/{Latitude:double}/{Zoom:double}"

<PageTitle>@Title</PageTitle>

<!-- #region telerik-media-query -->

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.MouseExtraSmall"
                   OnChange="@(match => TelerikDevice.MouseExtraSmall = match)" />

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.MouseSmall"
                   OnChange="@(match => TelerikDevice.MouseSmall = match)" />

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.MouseMedium"
                   OnChange="@(match => TelerikDevice.MouseMedium = match)" />

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.MouseLarge"
                   OnChange="@(match => TelerikDevice.MouseLarge = match)" />

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.MouseExtraLarge"
                   OnChange="@(match => TelerikDevice.MouseExtraLarge = match)" />

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.MouseExtraExtraLarge"
                   OnChange="@(match => TelerikDevice.MouseExtraExtraLarge = match)" />

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.TouchExtraSmall"
                   OnChange="@(match => TelerikDevice.TouchExtraSmall = match)" />

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.TouchSmall"
                   OnChange="@(match => TelerikDevice.TouchSmall = match)" />

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.TouchMedium"
                   OnChange="@(match => TelerikDevice.TouchMedium = match)" />

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.TouchLarge"
                   OnChange="@(match => TelerikDevice.TouchLarge = match)" />

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.TouchExtraLarge"
                   OnChange="@(match => TelerikDevice.TouchExtraLarge = match)" />

<TelerikMediaQuery Media="@TelerikMediaQueryDefaults.TouchExtraExtraLarge"
                   OnChange="@(match => TelerikDevice.TouchExtraExtraLarge = match)" />

<!-- #endregion -->

@{
    if ((TelerikDevice.MouseExtraSmall ?? false) ||
        (TelerikDevice.MouseSmall ?? false) ||
        (TelerikDevice.MouseMedium ?? false) ||
        (TelerikDevice.MouseLarge ?? false) ||
        (TelerikDevice.MouseExtraLarge ?? false) ||
        (TelerikDevice.MouseExtraExtraLarge ?? false)) {
        
        <div id="home">
            
            <!-- #region telerik-map -->
            
            <div id="home-telerik-map"
                 data-testid="telerik-map">
                
                <TelerikMap Center="@Center"
                            Height="100%"
                            MaxZoom="@TelerikMapDefaults.MaxZoom"
                            MinZoom="@TelerikMapDefaults.MinZoom"
                            OnMarkerClick="@OnMapMarkerClick"
                            OnPanEnd="@OnMapPanEndAsync"
                            OnZoomEnd="@OnMapZoomEndAsync"
                            Width="100%"
                            Zoom="@Zoom">
                    
                    <MapControls>
                        <MapControlsAttribution Enabled="true" 
                                                Position="MapControlsPosition.BottomRight" />
                        
                        <MapControlsNavigator Enabled="false"
                                              Position="MapControlsPosition.BottomLeft" />
                        
                        <MapControlsZoom Enabled="@(TelerikDevice.MouseExtraSmall == false)"
                                         Position="MapControlsPosition.TopRight" />
                    </MapControls>
                    
                    <MapLayers>
                        <MapLayer Type="@MapLayersType.Tile"
                                  Attribution="@TelerikMapDefaults.Attribution"
                                  Subdomains="@TelerikMapDefaults.Subdomains"
                                  UrlTemplate="@TelerikMapDefaults.UrlTemplate" />
                        
                        <MapLayer Type="@MapLayersType.Marker"
                                  Data="@MapData"
                                  LocationField="@nameof(TelerikStop.Location)">
                            
                            <MapLayerMarkerSettings Template="<span class='k-map-marker' data-testid='marker'>#= dataItem.Platform #</span>">
                                <MapLayerMarkerSettingsTooltip>
                                    <Template>
                                        
                                        @{
                                            var stop = context.DataItem as TelerikStop ?? new TelerikStop();
                                        }
                                        
                                        <div id="home-telerik-map__tooltip"
                                             data-testid="telerik-map__tooltip">
                                            
                                            <div class="name"
                                                 data-testid="name">
                                                
                                                @stop.Name
                                            </div>
                                            
                                            <div class="services"
                                                 data-testid="services">
                                                
                                                <ul>
                                                    @{
                                                        var points = stop.Points?
                                                            .Take(count: TelerikDevice.MouseExtraSmall == false ? 5 : 3)
                                                            .Select(selector: point => point)
                                                            .ToList() ?? [];
                                                        
                                                        foreach (var item in points)
                                                        {
                                                            var departureTime = item.DepartureDateTime?.ToString(
                                                                format: "HH:mm",
                                                                provider: CultureInfo.InvariantCulture);
                                                            
                                                            switch (item.RouteName)
                                                            {
                                                                case "BLUE":
                                                                    <li class="blue">@departureTime @item.DestinationName</li>
                                                                    break;
                                                                case "PURP":
                                                                    <li class="purp">@departureTime @item.DestinationName</li>
                                                                    break;
                                                                case "TT":
                                                                    <li class="tt">@departureTime @item.DestinationName</li>
                                                                    break;
                                                                case "YELL":
                                                                    <li class="yell">@departureTime @item.DestinationName</li>
                                                                    break;
                                                                default:
                                                                    <li class="default">@departureTime @item.DestinationName</li>
                                                                    break;
                                                            }
                                                        }
                                                    }
                                                </ul>
                                            </div>
                                        </div>
                                    </Template>
                                </MapLayerMarkerSettingsTooltip>
                            </MapLayerMarkerSettings>
                        </MapLayer>
                    </MapLayers>
                </TelerikMap>
            </div>
            
            <!-- #endregion -->
            
            <!-- #region telerik-list-view -->
            
            <div id="home-telerik-list-view"
                 data-testid="telerik-list-view">
                
                <TelerikListView EnableLoaderContainer="false"
                                 Height="100%"
                                 OnRead="@OnListReadAsync"
                                 Width="100%"
                                 TItem="@TelerikStop"
                                 @ref="@ListManager">
                    
                    <Template>
                        <div id="home-telerik-list-view__result"
                             data-testid="telerik-list-view__result"
                             @onclick="@( _ => OnListChange(stopId: context.Id) )">
                            
                            <div class="name"
                                 data-testid="name">
                                
                                @{
                                    var name = context.Name?
                                        .Split(separator: '-')
                                        .FirstOrDefault()?
                                        .Trim();
                                    
                                    name = name?
                                        .Split(separator: '/')
                                        .FirstOrDefault()?
                                        .Trim();
                                }
                                
                                @name
                            </div>
                            
                            <div class="direction"
                                 data-testid="direction">
                                
                                Direction: @context.Direction
                            </div>
                            
                            <div class="services"
                                 data-testid="services">
                                
                                <ul>
                                    @{
                                        var points = context.Points?
                                            .Take(count: TelerikDevice.MouseExtraSmall == true ? 5 : 3)
                                            .Select(selector: point => point)
                                            .ToList() ?? [];
                                        
                                        foreach (var item in points)
                                        {
                                            var departureTime = item.DepartureDateTime?.ToString(
                                                format: "HH:mm",
                                                provider: CultureInfo.InvariantCulture);
                                            
                                            switch (item.RouteName)
                                            {
                                                case "BLUE":
                                                    <li class="blue" title="@item.DestinationName">@departureTime</li>
                                                    break;
                                                case "PURP":
                                                    <li class="purp" title="@item.DestinationName">@departureTime</li>
                                                    break;
                                                case "TT":
                                                    <li class="tt" title="@item.DestinationName">@departureTime</li>
                                                    break;
                                                case "YELL":
                                                    <li class="yell" title="@item.DestinationName">@departureTime</li>
                                                    break;
                                                default:
                                                    <li class="default" title="@item.DestinationName">@departureTime</li>
                                                    break;
                                            }
                                        }
                                    }
                                </ul>
                            </div>
                        </div>
                    </Template>
                </TelerikListView>
            </div>
            
            <!-- #endregion -->
            
            <!-- #region telerik-auto-complete -->
            
            <div id="home-telerik-auto-complete"
                 data-testid="telerik-auto-complete">
                
                <TelerikAutoComplete @bind-value="@Query"
                                     DebounceDelay="@TelerikAutoCompleteDefaults.DebounceDelay"
                                     Filterable="true"
                                     MinLength="@TelerikAutoCompleteDefaults.MinCacheLength"
                                     OnChange="@OnSearchChange"
                                     OnClose="@OnSearchCloseAsync"
                                     OnOpen="@OnSearchOpenAsync"
                                     OnRead="@OnSearchReadAsync"
                                     Placeholder="@TelerikAutoCompleteDefaults.Placeholder"
                                     ValueField="@nameof(TelerikStop.Id)"
                                     TItem="@TelerikStop">
                    
                    <ItemTemplate>
                        <div id="home-telerik-auto-complete__result"
                             data-testid="telerik-auto-complete__result">
                            
                            <div class="name"
                                 data-testid="name">
                                
                                @context.Name
                            </div>
                            
                            <div class="direction"
                                 data-testid="direction">
                                
                                Direction: @context.Direction
                            </div>
                            
                            <div class="services"
                                 data-testid="services">
                                
                                <ul>
                                    @{
                                        var points = context.Points?
                                            .Take(count: TelerikDevice.MouseExtraSmall == false ? 5 : 3)
                                            .Select(selector: point => point)
                                            .ToList() ?? [];
                                        
                                        foreach (var item in points)
                                        {
                                            var departureTime = item.DepartureDateTime?.ToString(
                                                format: "HH:mm",
                                                provider: CultureInfo.InvariantCulture);
                                            
                                            switch (item.RouteName)
                                            {
                                                case "BLUE":
                                                    <li class="blue" title="@item.DestinationName">@departureTime</li>
                                                    break;
                                                case "PURP":
                                                    <li class="purp" title="@item.DestinationName">@departureTime</li>
                                                    break;
                                                case "TT":
                                                    <li class="tt" title="@item.DestinationName">@departureTime</li>
                                                    break;
                                                case "YELL":
                                                    <li class="yell" title="@item.DestinationName">@departureTime</li>
                                                    break;
                                                default:
                                                    <li class="default" title="@item.DestinationName">@departureTime</li>
                                                    break;
                                            }
                                        }
                                    }
                                </ul>
                            </div>
                        </div>
                    </ItemTemplate>
                    
                    <NoDataTemplate>
                        <div id="home-telerik-auto-complete__unknown">
                            <div class="error">No Stops Found</div>
                            <div class="message">Update Search Query and/or Filter</div>
                        </div>
                    </NoDataTemplate>
                </TelerikAutoComplete>
            </div>
            
            <!-- #endregion -->
            
            <!-- #region local-storage-consent -->
            
            <LocalStorageConsent Longitude="Center.ElementAt(index: 1)"
                                 Latitude="Center.ElementAt(index: 0)"
                                 Zoom="Zoom"/>
            
            <!-- #endregion -->
            
        </div>
    }
    else
    {
        <div id="home">
            
            <!-- #region telerik-map -->
            
            <div id="home-telerik-map"
                 data-testid="telerik-map">
                
                <TelerikMap Center="@Center"
                            Height="100%"
                            MaxZoom="@TelerikMapDefaults.MaxZoom"
                            MinZoom="@TelerikMapDefaults.MinZoom"
                            OnMarkerClick="@OnMapMarkerClick"
                            OnPanEnd="@OnMapPanEndAsync"
                            OnZoomEnd="@OnMapZoomEndAsync"
                            Width="100%"
                            Zoom="@Zoom">
                    
                    <MapControls>
                        <MapControlsAttribution Enabled="true" 
                                                Position="MapControlsPosition.BottomRight" />
                        
                        <MapControlsNavigator Enabled="false"
                                              Position="MapControlsPosition.BottomLeft" />
                        
                        <MapControlsZoom Enabled="@(TelerikDevice.MouseExtraSmall == false)"
                                         Position="MapControlsPosition.TopRight" />
                    </MapControls>
                    
                    <MapLayers>
                        <MapLayer Type="@MapLayersType.Tile"
                                  Attribution="@TelerikMapDefaults.Attribution"
                                  Subdomains="@TelerikMapDefaults.Subdomains"
                                  UrlTemplate="@TelerikMapDefaults.UrlTemplate" />
                        
                        <MapLayer Type="@MapLayersType.Marker"
                                  Data="@MapData"
                                  LocationField="@nameof(TelerikStop.Location)">
                            
                            <MapLayerMarkerSettings Template="<span class='k-map-marker' data-testid='marker'>#= dataItem.Platform #</span>" />
                        </MapLayer>
                    </MapLayers>
                </TelerikMap>
            </div>
            
            <!-- #endregion -->
            
            <!-- #region telerik-list-view -->
            
            <div id="home-telerik-list-view"
                 data-testid="telerik-list-view">
                
                <TelerikListView EnableLoaderContainer="false"
                                 Height="100%"
                                 OnRead="@OnListReadAsync"
                                 Width="100%"
                                 TItem="@TelerikStop"
                                 @ref="@ListManager">
                    
                    <Template>
                        <div id="home-telerik-list-view__result"
                             data-testid="telerik-list-view__result"
                             @onclick="@( _ => OnListChange(stopId: context.Id) )">
                            
                            <div class="name"
                                 data-testid="name">
                                
                                @{
                                    var name = context.Name?
                                        .Split(separator: '-')
                                        .FirstOrDefault()?
                                        .Trim();
                                    
                                    name = name?
                                        .Split(separator: '/')
                                        .FirstOrDefault()?
                                        .Trim();
                                }
                                
                                @name
                            </div>
                            
                            <div class="direction"
                                 data-testid="direction">
                                
                                Direction: @context.Direction
                            </div>
                            
                            <div class="services"
                                 data-testid="services">
                                
                                <ul>
                                    @{
                                        var points = context.Points?
                                            .Take(count: TelerikDevice.TouchExtraSmall == true ? 5 : 3)
                                            .Select(selector: point => point)
                                            .ToList() ?? [];
                                        
                                        foreach (var item in points)
                                        {
                                            var departureTime = item.DepartureDateTime?.ToString(
                                                format: "HH:mm",
                                                provider: CultureInfo.InvariantCulture);
                                            
                                            switch (item.RouteName)
                                            {
                                                case "BLUE":
                                                    <li class="blue">@departureTime</li>
                                                    break;
                                                case "PURP":
                                                    <li class="purp">@departureTime</li>
                                                    break;
                                                case "TT":
                                                    <li class="tt">@departureTime</li>
                                                    break;
                                                case "YELL":
                                                    <li class="yell">@departureTime</li>
                                                    break;
                                                default:
                                                    <li class="default">@departureTime</li>
                                                    break;
                                            }
                                        }
                                    }
                                </ul>
                            </div>
                        </div>
                    </Template>
                </TelerikListView>
            </div>
            
            <!-- #endregion -->
            
            <!-- #region telerik-auto-complete -->
            
            <div id="home-telerik-auto-complete"
                 data-testid="telerik-auto-complete">
                
                <TelerikAutoComplete @bind-value="@Query"
                                     DebounceDelay="@TelerikAutoCompleteDefaults.DebounceDelay"
                                     Filterable="true"
                                     MinLength="@TelerikAutoCompleteDefaults.MinCacheLength"
                                     OnChange="@OnSearchChange"
                                     OnClose="@OnSearchCloseAsync"
                                     OnOpen="@OnSearchOpenAsync"
                                     OnRead="@OnSearchReadAsync"
                                     Placeholder="@TelerikAutoCompleteDefaults.Placeholder"
                                     ValueField="@nameof(TelerikStop.Id)"
                                     TItem="@TelerikStop">
                    
                    <ItemTemplate>
                        <div id="home-telerik-auto-complete__result"
                             data-testid="telerik-auto-complete__result">
                            
                            <div class="name"
                                 data-testid="name">
                                
                                @context.Name
                            </div>
                            
                            <div class="direction"
                                 data-testid="direction">
                                
                                Direction: @context.Direction
                            </div>
                            
                            <div class="services"
                                 data-testid="services">
                                
                                <ul>
                                    @{
                                        var points = context.Points?
                                            .Take(count: TelerikDevice.TouchExtraSmall == false ? 5 : 3)
                                            .Select(selector: point => point)
                                            .ToList() ?? [];
                                        
                                        foreach (var item in points)
                                        {
                                            var departureTime = item.DepartureDateTime?.ToString(
                                                format: "HH:mm",
                                                provider: CultureInfo.InvariantCulture);
                                            
                                            switch (item.RouteName)
                                            {
                                                case "BLUE":
                                                    <li class="blue">@departureTime</li>
                                                    break;
                                                case "PURP":
                                                    <li class="purp">@departureTime</li>
                                                    break;
                                                case "TT":
                                                    <li class="tt">@departureTime</li>
                                                    break;
                                                case "YELL":
                                                    <li class="yell">@departureTime</li>
                                                    break;
                                                default:
                                                    <li class="default">@departureTime</li>
                                                    break;
                                            }
                                        }
                                    }
                                </ul>
                            </div>
                        </div>
                    </ItemTemplate>
                    
                    <NoDataTemplate>
                        <div id="home-telerik-auto-complete__unknown">
                            <div class="error">No Stops Found</div>
                            <div class="message">Update Search Query and/or Filter</div>
                        </div>
                    </NoDataTemplate>
                </TelerikAutoComplete>
            </div>
            
            <!-- #endregion -->
            
            <!-- #region local-storage-consent -->
            
            <LocalStorageConsent Longitude="Center.ElementAt(index: 1)"
                                 Latitude="Center.ElementAt(index: 0)"
                                 Zoom="Zoom" />
            
            <!-- #endregion -->
            
        </div>
    }
}